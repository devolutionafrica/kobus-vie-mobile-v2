import{b as w}from"./chunk-I3BU47JI.js";import{h as i}from"./chunk-LNJ3S2LQ.js";var d=(()=>{class c extends w{constructor(){super()}parseJwt(e){let n=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(n).split("").map(s=>"%"+("00"+s.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(r)}loadScript(e){return i(this,null,function*(){return new Promise((t,n)=>{let r=document.createElement("script");r.src=e,r.async=!0,r.onload=()=>{t()},r.onerror=n,document.body.appendChild(r)})})}}return c.OAUTH_STATE_KEY="social_login_oauth_pending",c})();var v=class extends d{constructor(){super(...arguments),this.clientId=null,this.redirectUrl=null,this.scriptLoaded=!1,this.scriptUrl="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js"}initialize(o,e){return i(this,null,function*(){this.clientId=o,this.redirectUrl=e||null,o&&(yield this.loadAppleScript())})}login(o){return i(this,null,function*(){if(!this.clientId)throw new Error("Apple Client ID not set. Call initialize() first.");if(!this.scriptLoaded)throw new Error("Apple Sign-In script not loaded.");return new Promise((e,t)=>{var n;AppleID.auth.init({clientId:this.clientId,scope:((n=o.scopes)===null||n===void 0?void 0:n.join(" "))||"name email",redirectURI:this.redirectUrl||window.location.href,state:o.state,nonce:o.nonce,usePopup:!0}),AppleID.auth.signIn().then(r=>{var s,l,a,u,h;let T={profile:{user:r.user||"",email:((s=r.user)===null||s===void 0?void 0:s.email)||null,givenName:((a=(l=r.user)===null||l===void 0?void 0:l.name)===null||a===void 0?void 0:a.firstName)||null,familyName:((h=(u=r.user)===null||u===void 0?void 0:u.name)===null||h===void 0?void 0:h.lastName)||null},accessToken:{token:r.authorization.id_token||""},idToken:r.authorization.code||null};e({provider:"apple",result:T})}).catch(r=>{t(r)})})})}logout(){return i(this,null,function*(){console.log("Apple logout: Session should be managed on the client side")})}isLoggedIn(){return i(this,null,function*(){return console.log("Apple login status should be managed on the client side"),{isLoggedIn:!1}})}getAuthorizationCode(){return i(this,null,function*(){throw console.log("Apple authorization code should be stored during login"),new Error("Apple authorization code not available")})}refresh(){return i(this,null,function*(){console.log("Apple refresh not available on web")})}loadAppleScript(){return i(this,null,function*(){if(!this.scriptLoaded)return this.loadScript(this.scriptUrl).then(()=>{this.scriptLoaded=!0})})}};var _=class extends d{constructor(){super(...arguments),this.appId=null,this.scriptLoaded=!1}initialize(o){return i(this,null,function*(){this.appId=o,o&&(yield this.loadFacebookScript(),FB.init({appId:this.appId,version:"v17.0",xfbml:!0,cookie:!0}))})}login(o){return i(this,null,function*(){if(!this.appId)throw new Error("Facebook App ID not set. Call initialize() first.");return new Promise((e,t)=>{FB.login(n=>{n.status==="connected"?FB.api("/me",{fields:"id,name,email,picture"},r=>{var s,l;let a={accessToken:{token:n.authResponse.accessToken,userId:n.authResponse.userID},profile:{userID:r.id,name:r.name,email:r.email||null,imageURL:((l=(s=r.picture)===null||s===void 0?void 0:s.data)===null||l===void 0?void 0:l.url)||null,friendIDs:[],birthday:null,ageRange:null,gender:null,location:null,hometown:null,profileURL:null},idToken:null};e({provider:"facebook",result:a})}):t(new Error("Facebook login failed"))},{scope:o.permissions.join(",")})})})}logout(){return i(this,null,function*(){return new Promise(o=>{FB.logout(()=>o())})})}isLoggedIn(){return i(this,null,function*(){return new Promise(o=>{FB.getLoginStatus(e=>{o({isLoggedIn:e.status==="connected"})})})})}getAuthorizationCode(){return i(this,null,function*(){return new Promise((o,e)=>{FB.getLoginStatus(t=>{var n;t.status==="connected"?o({jwt:((n=t.authResponse)===null||n===void 0?void 0:n.accessToken)||""}):e(new Error("No Facebook authorization code available"))})})})}refresh(o){return i(this,null,function*(){yield this.login(o)})}loadFacebookScript(){return i(this,null,function*(){if(!this.scriptLoaded)return this.loadScript("https://connect.facebook.net/en_US/sdk.js").then(()=>{this.scriptLoaded=!0})})}};var E=class extends d{constructor(){super(...arguments),this.clientId=null,this.loginType="online",this.GOOGLE_TOKEN_REQUEST_URL="https://www.googleapis.com/oauth2/v3/tokeninfo",this.GOOGLE_STATE_KEY="capgo_social_login_google_state"}initialize(o,e,t,n){return i(this,null,function*(){this.clientId=o,e&&(this.loginType=e),this.hostedDomain=t,this.redirectUrl=n})}login(o){return i(this,null,function*(){if(!this.clientId)throw new Error("Google Client ID not set. Call initialize() first.");let e=o.scopes||[];e.length>0?(e.includes("https://www.googleapis.com/auth/userinfo.email")||e.push("https://www.googleapis.com/auth/userinfo.email"),e.includes("https://www.googleapis.com/auth/userinfo.profile")||e.push("https://www.googleapis.com/auth/userinfo.profile"),e.includes("openid")||e.push("openid")):e=["https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/userinfo.profile","openid"];let t=o.nonce||Math.random().toString(36).substring(2);return this.traditionalOAuth({scopes:e,nonce:t,hostedDomain:this.hostedDomain})})}logout(){return i(this,null,function*(){if(this.loginType==="offline")return Promise.reject("Offline login doesn't store tokens. logout is not available");let o=this.getGoogleState();o&&(yield this.rawLogoutGoogle(o.accessToken))})}isLoggedIn(){return i(this,null,function*(){if(this.loginType==="offline")return Promise.reject("Offline login doesn't store tokens. isLoggedIn is not available");let o=this.getGoogleState();if(!o)return{isLoggedIn:!1};try{let e=yield this.accessTokenIsValid(o.accessToken),t=this.idTokenValid(o.idToken);if(e&&t)return{isLoggedIn:!0};try{yield this.rawLogoutGoogle(o.accessToken,!1)}catch(n){console.error("Access token is not valid, but cannot logout",n)}return{isLoggedIn:!1}}catch(e){return Promise.reject(e)}})}getAuthorizationCode(){return i(this,null,function*(){if(this.loginType==="offline")return Promise.reject("Offline login doesn't store tokens. getAuthorizationCode is not available");let o=this.getGoogleState();if(!o)throw new Error("No Google authorization code available");try{let e=yield this.accessTokenIsValid(o.accessToken),t=this.idTokenValid(o.idToken);if(e&&t)return{accessToken:o.accessToken,jwt:o.idToken};try{yield this.rawLogoutGoogle(o.accessToken,!1)}catch(n){console.error("Access token is not valid, but cannot logout",n)}throw new Error("No Google authorization code available")}catch(e){return Promise.reject(e)}})}refresh(){return i(this,null,function*(){return Promise.reject("Not implemented")})}handleOAuthRedirect(o){let e=o.searchParams,t=e.get("code");if(t&&e.has("scope"))return{provider:"google",result:{serverAuthCode:t,responseType:"offline"}};let n=o.hash.substring(1);if(console.log("handleOAuthRedirect",o.hash),!n)return null;console.log("handleOAuthRedirect ok");let r=new URLSearchParams(n),s=r.get("access_token"),l=r.get("id_token");if(s&&l){localStorage.removeItem(d.OAUTH_STATE_KEY);let a=this.parseJwt(l);return{provider:"google",result:{accessToken:{token:s},idToken:l,profile:{email:a.email||null,familyName:a.family_name||null,givenName:a.given_name||null,id:a.sub||null,name:a.name||null,imageUrl:a.picture||null},responseType:"online"}}}return null}accessTokenIsValid(o){return i(this,null,function*(){let e=`${this.GOOGLE_TOKEN_REQUEST_URL}?access_token=${encodeURIComponent(o)}`;try{let t=yield fetch(e);if(!t.ok)return console.log(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response not successful. Status code: ${t.status}. Assuming that the token is not valid`),!1;let n=yield t.text();if(!n)throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is null`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is null`);let r;try{r=JSON.parse(n)}catch(a){throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is not valid JSON. Error: ${a}`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is not valid JSON. Error: ${a}`)}let s=r.expires_in;if(s==null)throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response JSON does not include 'expires_in'.`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response JSON does not include 'expires_in'.`);let l;try{if(l=parseInt(s,10),isNaN(l))throw new Error("'expires_in' is not a valid integer")}catch(a){throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. 'expires_in': ${s} is not a valid integer. Error: ${a}`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. 'expires_in': ${s} is not a valid integer. Error: ${a}`)}return l>5}catch(t){throw console.error(t),t}})}idTokenValid(o){try{let e=this.parseJwt(o),t=Math.ceil(Date.now()/1e3)+5;return e.exp&&t<e.exp}catch{return!1}}rawLogoutGoogle(o,e=null){return i(this,null,function*(){if(e===null&&(e=yield this.accessTokenIsValid(o)),e===!0){try{yield fetch(`https://accounts.google.com/o/oauth2/revoke?token=${encodeURIComponent(o)}`),this.clearStateGoogle()}catch{}return}else{this.clearStateGoogle();return}})}persistStateGoogle(o,e){try{window.localStorage.setItem(this.GOOGLE_STATE_KEY,JSON.stringify({accessToken:o,idToken:e}))}catch(t){console.error("Cannot persist state google",t)}}clearStateGoogle(){try{window.localStorage.removeItem(this.GOOGLE_STATE_KEY)}catch(o){console.error("Cannot clear state google",o)}}getGoogleState(){try{let o=window.localStorage.getItem(this.GOOGLE_STATE_KEY);if(!o)return null;let{accessToken:e,idToken:t}=JSON.parse(o);return{accessToken:e,idToken:t}}catch(o){return console.error("Cannot get state google",o),null}}traditionalOAuth(n){return i(this,arguments,function*({scopes:o,hostedDomain:e,nonce:t}){let r=[...new Set([...o||[],"openid"])],s=new URLSearchParams(Object.assign(Object.assign({client_id:this.clientId,redirect_uri:this.redirectUrl||window.location.origin+window.location.pathname,response_type:this.loginType==="offline"?"code":"token id_token",scope:r.join(" ")},t&&{nonce:t}),{include_granted_scopes:"true",state:"popup"}));e!==void 0&&s.append("hd",e);let l=`https://accounts.google.com/o/oauth2/v2/auth?${s.toString()}`,a=500,u=600,h=window.screenX+(window.outerWidth-a)/2,T=window.screenY+(window.outerHeight-u)/2;localStorage.setItem(d.OAUTH_STATE_KEY,"true");let k=window.open(l,"Google Sign In",`width=${a},height=${u},left=${h},top=${T},popup=1`),I,A;return new Promise((U,S)=>{if(!k){S(new Error("Failed to open popup"));return}let y=g=>{var O,L,b;if(!(g.origin!==window.location.origin||!((L=(O=g.data)===null||O===void 0?void 0:O.source)===null||L===void 0)&&L.startsWith("angular"))&&((b=g.data)===null||b===void 0?void 0:b.type)==="oauth-response")if(window.removeEventListener("message",y),clearInterval(I),this.loginType==="online"){let{accessToken:f,idToken:m}=g.data;if(f&&m){let p=this.parseJwt(m);this.persistStateGoogle(f.token,m),U({provider:"google",result:{accessToken:{token:f.token},idToken:m,profile:{email:p.email||null,familyName:p.family_name||null,givenName:p.given_name||null,id:p.sub||null,name:p.name||null,imageUrl:p.picture||null},responseType:"online"}})}}else{let{serverAuthCode:f}=g.data;U({provider:"google",result:{responseType:"offline",serverAuthCode:f}})}};window.addEventListener("message",y),A=setTimeout(()=>{clearTimeout(A),window.removeEventListener("message",y),k.close(),S(new Error("OAuth timeout"))},3e5),I=setInterval(()=>{k.closed&&(clearInterval(I),S(new Error("Popup closed")))},1e3)})})}};var V=(()=>{class c extends w{constructor(){var e;if(super(),this.googleProvider=new E,this.appleProvider=new v,this.facebookProvider=new _,localStorage.getItem(c.OAUTH_STATE_KEY)){console.log("OAUTH_STATE_KEY found");let t=this.handleOAuthRedirect();t&&((e=window.opener)===null||e===void 0||e.postMessage(Object.assign({type:"oauth-response"},t.result),window.location.origin),window.close())}}handleOAuthRedirect(){let e=new URL(window.location.href);return this.googleProvider.handleOAuthRedirect(e)}initialize(e){return i(this,null,function*(){var t,n,r;let s=[];!((t=e.google)===null||t===void 0)&&t.webClientId&&s.push(this.googleProvider.initialize(e.google.webClientId,e.google.mode,e.google.hostedDomain,e.google.redirectUrl)),!((n=e.apple)===null||n===void 0)&&n.clientId&&s.push(this.appleProvider.initialize(e.apple.clientId,e.apple.redirectUrl)),!((r=e.facebook)===null||r===void 0)&&r.appId&&s.push(this.facebookProvider.initialize(e.facebook.appId)),yield Promise.all(s)})}login(e){return i(this,null,function*(){switch(e.provider){case"google":return this.googleProvider.login(e.options);case"apple":return this.appleProvider.login(e.options);case"facebook":return this.facebookProvider.login(e.options);default:throw new Error(`Login for ${e.provider} is not implemented on web`)}})}logout(e){return i(this,null,function*(){switch(e.provider){case"google":return this.googleProvider.logout();case"apple":return this.appleProvider.logout();case"facebook":return this.facebookProvider.logout();default:throw new Error(`Logout for ${e.provider} is not implemented`)}})}isLoggedIn(e){return i(this,null,function*(){switch(e.provider){case"google":return this.googleProvider.isLoggedIn();case"apple":return this.appleProvider.isLoggedIn();case"facebook":return this.facebookProvider.isLoggedIn();default:throw new Error(`isLoggedIn for ${e.provider} is not implemented`)}})}getAuthorizationCode(e){return i(this,null,function*(){switch(e.provider){case"google":return this.googleProvider.getAuthorizationCode();case"apple":return this.appleProvider.getAuthorizationCode();case"facebook":return this.facebookProvider.getAuthorizationCode();default:throw new Error(`getAuthorizationCode for ${e.provider} is not implemented`)}})}refresh(e){return i(this,null,function*(){switch(e.provider){case"google":return this.googleProvider.refresh();case"apple":return this.appleProvider.refresh();case"facebook":return this.facebookProvider.refresh(e.options);default:throw new Error(`Refresh for ${e.provider} is not implemented`)}})}providerSpecificCall(e){return i(this,null,function*(){throw new Error(`Provider specific call for ${e.call} is not implemented`)})}}return c.OAUTH_STATE_KEY="social_login_oauth_pending",c})();export{V as SocialLoginWeb};
